<!-- templates/registration/login.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-1">
    <div class="row">
        <div class="col-12 col-lg-8">
            {% if expenses %}
            <div class="d-flex justify-content-center">
                <div class="chart-container" style="height:40vh; width:40vh">
                    <canvas id="spendchart"></canvas>
                </div>
            </div>
            {% endif %}
            <form action="set-budget" method="post">
                {% csrf_token %}
                <div class="input-group mb-3">
                    <input type="number" name="amount" class="form-control" id="amount" placeholder="Monthly Budget" value="{{ budget.amount }}">
                    <input type="text" size="5" name="currency" class="input-group-text" id="currency" value="{{ budget.currency|default:'ZAR' }}" />
                    <input type="submit" value="Set" class="btn btn-primary">
                </div>
            </form>
            {% if budget %}
            <div class="progress" role="progressbar">
                <div class="progress-bar" style="width: {{ budget_percentage }}%">{{ budget_percentage }}%</div>
            </div>
            {% endif %}
            {% if expenses %}
            <table class="table table-hover mt-2">
                <caption>{{ current_date|date:"M" }}: {{ total_spend }}</caption>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ex in expenses %}
                    <tr>
                        <td>{{ ex.date }}</td>
                        <td>{{ ex.description }}</td>
                        <td>{{ ex.amount }}</td>
                        <td>{{ ex.category.name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="height:50vh" class="d-flex justify-content-center align-items-center">
                <h4>No expenses this month</h4>
            </div>
            {% endif %}
        </div>
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Log Expense</h5>
                    <form action="{% url 'budget:add_expense' %}" method="post">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <button type="submit" class="btn btn-success mt-3">Add</button>
                    </form>
                  </div>
            </div>
        </div>
    </div>
    <nav aria-label="Expenses navigation" class="fixed-bottom navbar-light bg-light">
        <ul class="pagination justify-content-center pt-3">
          <li class="page-item">
            <a class="page-link" href="/{{ prev_date.year }}/{{ prev_date.month }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>                        
          </li>
          <li class="page-item"><a class="page-link" href="/{{ prev_date.year }}/{{ prev_date.month }}">{{ prev_date|date:"M" }}</a></li>
          <li class="page-item active"><a class="page-link" href="#">{{ current_date|date:"M" }}</a></li>
          <li class="page-item"><a class="page-link" href="/{{ next_date.year }}/{{ next_date.month }}">{{ next_date|date:"M" }}</a></li>
          <li class="page-item">
            <a class="page-link" href="/{{ next_date.year }}/{{ next_date.month }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>                        
          </li>
        </ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

<script>
const spendData = JSON.parse("{{ data|escapejs }}");
document.addEventListener("DOMContentLoaded", function(event) {
    const ctx = document.getElementById('spendchart');

    new Chart(ctx, {
    type: 'pie',
    data: {
        datasets: [{
            data: spendData.amounts
        }],
        labels: spendData.categories
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true,
                position: "right"
            }
        }
    }
    });
})
</script>
{% endblock %}